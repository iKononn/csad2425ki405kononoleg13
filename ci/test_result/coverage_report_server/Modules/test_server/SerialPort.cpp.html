<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>SerialPort.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
#include "pch.h"
#include "SerialPort.h"

<span style = "background-color:#dfd">HANDLE openSerialPort(const wstring&amp; portName, DWORD baudRate) {
    HANDLE hSerial = CreateFile(portName.c_str(),</span>
        GENERIC_READ | GENERIC_WRITE,
        0,
        NULL,
        OPEN_EXISTING,
        FILE_ATTRIBUTE_NORMAL,
        NULL);
<span style = "background-color:#dfd">    if (hSerial == INVALID_HANDLE_VALUE) {</span>
<span style = "background-color:#fdd">        return INVALID_HANDLE_VALUE;</span>
    }
<span style = "background-color:#dfd">    DCB dcbSerialParams = { 0 };
    dcbSerialParams.DCBlength = sizeof(dcbSerialParams);
    if (!GetCommState(hSerial, &amp;dcbSerialParams)) {</span>
<span style = "background-color:#fdd">        CloseHandle(hSerial);
        return INVALID_HANDLE_VALUE;</span>
    }
<span style = "background-color:#dfd">    dcbSerialParams.BaudRate = baudRate;
    dcbSerialParams.ByteSize = 8;
    dcbSerialParams.StopBits = ONESTOPBIT;
    dcbSerialParams.Parity = NOPARITY;
    if (!SetCommState(hSerial, &amp;dcbSerialParams)) {</span>
<span style = "background-color:#fdd">        CloseHandle(hSerial);
        return INVALID_HANDLE_VALUE;</span>
    }
<span style = "background-color:#dfd">    COMMTIMEOUTS timeouts = { 0 };
    timeouts.ReadIntervalTimeout = 50;
    timeouts.ReadTotalTimeoutConstant = 50;
    timeouts.ReadTotalTimeoutMultiplier = 10;
    timeouts.WriteTotalTimeoutConstant = 50;
    timeouts.WriteTotalTimeoutMultiplier = 10;
    SetCommTimeouts(hSerial, &amp;timeouts);
    return hSerial;
}</span>

<span style = "background-color:#dfd">void sendMessage(HANDLE hSerial, string message) {
    string stdMessage = message;</span>
    DWORD bytesWritten;
<span style = "background-color:#dfd">    WriteFile(hSerial, stdMessage.c_str(), stdMessage.size(), &amp;bytesWritten, NULL);
}</span>

<span style = "background-color:#dfd">string readMessage(HANDLE hSerial) {</span>
    char buffer[256];
    DWORD bytesRead;
<span style = "background-color:#dfd">    string result;
    while (true) {
        if (ReadFile(hSerial, buffer, sizeof(buffer) - 1, &amp;bytesRead, NULL)) {
            buffer[bytesRead] = '\0';
            result += buffer;
            if (result.find('\n') != string::npos) {
                break;</span>
            }
        }
<span style = "background-color:#dfd">    }
    return result;
}</span></pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>